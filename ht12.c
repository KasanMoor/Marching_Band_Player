/* ht9.c
 * this program must be run as super user to access usb devices
 * sudo apt-get install libftdi-dev
 * sudo apt-get install libncurses5-dev
 * compile: gcc -O2 ht9.c -lftdi -lncurses -o ht9
 * this program transmits dmx-style rgb packets
 * modified to adjust to software PWM on the Mrfs
 * broadcasts from PC/Xbee to Mrf/Arduino
 *
 * really going to try constant broadcast this time
 * and... it flickers really badly on holds
 * 
 * Benjamin Jeffery
 * University of Idaho
 * 11/11/2015
 * millisec() is copied from unicon/src/common/time.c 
 * for testing purposes. Thanks Clint
 */

#include <ftdi.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
/* #include <time.h> */
/* #include <sys/times.h> */
#include <curses.h>
#include <string.h>

#define DOT   100000
#define DASH  300000
#define DORK  150000
#define DROOL 1000000
#define DAB   50000
#define SLP   40000

//static size_t encode(const uint8_t* source, size_t size, uint8_t* destination);
static size_t getEncodedBufferSize(size_t sourceSize);
long millisec();
uint8_t sorc[96] = { };
uint8_t dest[96] = { };

void rotate13 (uint8_t arr[]);
void chase(uint8_t arr[]);
void chaseUpper(uint8_t arr[]);
void printPack(uint8_t arr[]);

int main()
{
  struct ftdi_context *ftdi;
  struct ftdi_device_list *devlist, *curdev;
  char manufacturer[128], description[128];
  int retval = EXIT_SUCCESS;
  char letter;
  char myterm;
  bool news;
  int i = 0;
  int j = 0;
  int k = 0;
  int ret = 0;
  int res;
  int xbee_stat;
  int nbytes;
  int pm;
  int f;
  size_t write_index;
  long strt, stp;
  uint8_t temp[3] = { };
  uint8_t dPack[96] = { };
  uint8_t whitePack[96] = {255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                           255,255,215, 255,255,215, 255,255,215, 255,255,215};

  uint8_t whit2Pack[96] = {255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255};

  uint8_t redPack[96] =   {255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0,
                           255,0,0,     255,0,0,     255,0,0,     255,0,0};

  uint8_t greenPack[96] = {0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0,
                           0,255,0,     0,255,0,     0,255,0,     0,255,0};

  uint8_t bluePack[96] =  {0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255,
                           0,0,255,     0,0,255,     0,0,255,     0,0,255};

  uint8_t yellowPack[96] ={255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0,
                           255,255,0,   255,255,0,   255,255,0,   255,255,0};

  uint8_t chasePack[96] = {255,215,0,   255,215,0,       255,215,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0,
                           255,215,0,   255,215,0,       255,215,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0,
                           0,0,0,       0,0,0,       0,0,0,       0,0,0};

  uint8_t cyanPack[96] =  {0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255,
                           0,255,255,   0,255,255,   0,255,255,   0,255,255};

  uint8_t magentaPack[96]={255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255,
                           255,0,255,   255,0,255,   255,0,255,   255,0,255};

 // modification of green - makes channels DE (color guard) red, adds a gold  sparkle
  uint8_t tree1[96] =    {255,215,0,   0,255,0,     0,255,0,     0,255,0, //0123
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //4567
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //89AB
                          0,255,0,     255,0,0,     255,0,0,     0,255,0, //CDEF
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //0123
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //4567
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //89AB
                          0,255,0,     255,0,0,     255,0,0,     0,255,0};//CDEF

 // modification of green - makes channels DE (color guard) gold and red, adds a white sparkle
  uint8_t tree2[96] =    {255,255,255, 0,255,0,     0,255,0,     0,255,0, //0123
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //4567
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //89AB
                          0,255,0,     255,0,0,     255,215,0,   0,255,0, //CDEF
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //0123
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //4567
                          0,255,0,     0,255,0,     0,255,0,     0,255,0, //89AB
                          0,255,0,     255,0,0,     255,215,0,   0,255,0};//CDEF

 // mod of white - adds gold sparkle
  uint8_t snowman1[96] = {255,215,0,   255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                          255,215,0,   255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215, 
                          255,255,215, 255,255,215, 255,255,215, 255,255,215};

 // mod of whit2 - adds a gold sparkle
 
  uint8_t snowman2[96] =  {255,215,0,   255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,215,0,   255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                           255,255,255, 255,255,255, 255,255,255, 255,255,255};

  uint8_t indigoPack[96] = {75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130,
                            75,0,130,  75,0,130,  75,0,130,  75,0,130};

  uint8_t coralPack[96] =   {255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80,
                             255,127,80,  255,127,80,  255,127,80,  255,127,80};

  uint8_t dodgerPack[96] =  {30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255,
                             30,144,255,  30,144,255,  30,144,255,  30,144,255};
  
// gold is 255,215,0
  uint8_t goldPack[96] =  {255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0, 
                           255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0,
                           255,205,0,  255,205,0,  255,205,0,  255,205,0};

  uint8_t ui1Pack[96] =   {255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215, 
                           255,215,0,  255,255,215,  255,215,0,  255,255,215,
                           255,215,0,  255,255,215,  255,215,0,  255,255,215};

  uint8_t ui2Pack[96] =   {255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0, 
                           255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0,
                           255,255,215,  255,215,0,  255,255,215,  255,215,0};

  uint8_t twnk1Pack[96] =  {85,80,0,  80,80,0,  0,155,0,  80,80,0,
                            80,80,0,  80,80,0,  155,0,0,  80,80,0,
                            60,55,0,  80,80,0,  255,255,255,  80,80,0,
                            85,80,0,  80,80,0,  80,75,0,  80,80,0, 
                        155,155,155,  80,80,0,  85,80,0,  80,80,0,
                            80,85,0,  80,80,0,  80,80,0,  80,80,0,
                          155,115,0,  80,80,0,  80,75,0,  80,80,0,
                            80,80,0,  80,80,0,  85,80,0,  80,80,0};

 uint8_t twnk2Pack[96] =   {80,80,0,  155,150,0,  80,80,0,  80,75,0,
                            80,80,0,  80,80,0,  80,80,0,  255,0,0,
                            80,80,0,  150,155,0,  80,80,0,  60,60,55,
                            80,80,0,  85,80,0,  80,80,0,  80,75,0, 
                            80,80,0,  160,160,155,  80,80,0,  85,80,0,
                            80,80,0,  80,75,0,  80,80,0,  80,80,0,
                            80,80,0,  0,0,0,  80,80,0,  80,75,0,
                            80,70,0,  80,70,0,  80,80,0,  155,115,0};

 uint8_t twnk3Pack[96] =   {80,80,0,  80,80,0,  85,80,0,  80,80,0,
                            80,75,0,  80,80,0,  80,80,155,  80,80,0,
                            85,80,0,  80,80,0,  60,55,0,  80,80,0,
                            80,80,0,  80,80,0,  155,0,0,  80,80,0,
                            80,75,0,  80,80,0,  80,80,0,  80,80,0,
                            85,80,0,  80,80,0,  0,155,0,  80,80,0,
                            80,80,0,  0,0,0,  85,80,0,  80,80,0,
                            80,75,0,  80,80,0,  0,0,155,  80,80,0};

 uint8_t twnk4Pack[96] = {155,0,0, 80,80,75, 80,85,0, 255,215,0, 80,80,0, 80,75,0, 255,255,215, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 85,80,0, 0,0,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 0,0,0, 80,80,0, 255,115,0, 85,80,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0};

  uint8_t twnk5Pack[96] = {80,75,0, 255,0,0, 80,80,0, 80,75,0, 85,80,0, 0,0,255, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,0,0, 80,80,75, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 0,0,255, 80,75,0, 85,80,0};

  uint8_t twnk6Pack[96] = {80,80,0, 0,255,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,0,0, 80,80,0, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 0,255,0, 85,80,0, 0,0,255, 80,75,0, 85,80,0, 80,80,0, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 255,0,0, 80,80,0, 0,255,0, 85,80,0, 0,0,255, 80,75,0};


  uint8_t twnk7Pack[96] = {85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 0,0,255, 80,75,0, 255,215,0, 80,80,05, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 0,0,255};
  
uint8_t twnk8Pack[96] = {255,255,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 75,75,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,0,0, 80,80,0, 0,255,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0};

  uint8_t twnk9Pack[96] = {85,85,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 75,75,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 75,75,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,255, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 0,0,255, 80,75,0, 255,215,0, 80,80,0, 0,255,0};

  uint8_t twnk10Pack[96] = {85,75,0, 255,255,255, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,0,0, 0,0,255, 0,255,0, 255,215,0, 80,80,0, 80,75,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0};

  uint8_t twnk11Pack[96] = {80,75,0, 85,85,0, 255,255,255, 80,75,0, 255,215,0, 80,80,0, 0,255,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 0,0,255, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 80,85,0, 255,0,0, 80,80,0, 80,75,0, 255,215,0, 80,80,0, 0,255,0, 85,80,0, 80,80,0, 80,75,0, 255,215,0};

  uint8_t twnk12Pack[96] = {85,80,0, 80,80,0, 150,135,0, 80,80,0, 80,80,0, 80,80,0, 155,140,0, 80,80,0, 80,85,0, 80,80,0, 70,70,0, 80,80,0, 85,80,0, 80,80,0, 70,65,0, 80,80,0, 170,170,155, 80,80,0, 155,150,0, 80,80,0, 70,65,0, 80,80,0, 60,60,55, 80,80,0, 155,115,0, 80,80,0, 70,65,0, 80,80,0, 70,70,55, 80,80,0, 55,50,0, 80,80,0};

 uint8_t twnk13Pack[96] = {0,0,0, 155,140,0, 0,0,0, 60,55,0, 0,0,0, 70,70,55, 0,0,0, 55,50,0, 0,0,0, 170,155,0, 0,0,0, 60,60,55, 0,0,0, 55,50,0, 0,0,0, 60,55,0, 0,0,0, 170,170,155, 0,0,0, 55,50,0, 0,0,0, 60,55,0, 0,0,0, 60,60,55, 0,0,0, 155,140,0, 0,0,0, 60,55,0, 0,0,0, 60,60,55, 0,0,0, 155,115,0};


  uint8_t rain1Pack[96] = {255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 0,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 0,0,0, 0,206,209, 186,85,211};

  uint8_t rain2Pack[96] = {186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 0,0,0, 255,215,0, 0,0,0, 141,239,79, 0,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 0,0,0, 141,239,79, 131,194,209, 0,206,209};

  uint8_t rain3Pack[96] = {0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 0,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 0,0,0};

  uint8_t rain4Pack[96] = {0,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79};

  uint8_t rain5Pack[96] = {141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,0,55, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,0, 255,127,80, 0,0,0, 255,215,0, 220,20,60};

  uint8_t rain6Pack[96] = {220,20,60, 141,239,79, 0,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,0,0, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 0,0,0, 255,127,80, 30,144,255, 255,215,0};

  uint8_t rain7Pack[96] = {255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255};

  uint8_t rain8Pack[96] = {30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80};

  uint8_t rain9Pack[96] = {255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130};

  uint8_t rain10Pack[96] = {75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255};

  uint8_t rain11Pack[96] = {255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255};

  uint8_t rain12Pack[96] = {0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0};

  uint8_t rain13Pack[96] = {255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255};

  uint8_t rain14Pack[96] = {0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0};

  uint8_t rain15Pack[96] = {0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0};

  uint8_t rain16Pack[96] = {255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255, 255,0,0, 0,255,0, 0,0,255, 255,255,0, 0,255,255, 255,0,255, 75,0,130, 255,127,80, 30,144,255, 255,215,0, 220,20,60, 141,239,79, 31,194,109, 0,206,209, 186,85,211, 255,255,255};

  uint8_t spark1Pack[96] = {
    0,0,0, 0,0,0,   0,0,0,   0,0,0, 
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,206,209, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,206,209, 0,0,0};

  uint8_t spark2Pack[96] = {
    0,0,0, 0,0,0,   0,0,0,   0,0,0, 
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 131,194,209, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 131,194,209, 0,0,0};

  uint8_t spark3Pack[96] = {
    0,0,0, 0,0,0,   0,0,0,   0,0,0, 
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 141,239,79, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 141,239,79, 0,0,0};

  uint8_t spark4Pack[96] = {
    0,0,0, 0,0,0,   0,0,0,   0,0,0, 
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 220,20,60, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0,   0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 0,0,0, 0,0,0,
    0,0,0, 0,0,0, 220,20,60, 0,0,0};


 uint8_t glowPack[96] = {85,80,0,  80,80,0,  80,85,0,  85,80,0,
                         80,80,0,  80,75,0,  95,90,0,  80,80,0,
                         80,80,0,  85,80,0,  80,80,0,  70,70,0,
                         75,70,0,  70,70,0,  70,70,0,  75,70,0, 
                         70,70,0,  70,70,0,  75,70,0,  70,70,0,
                         70,70,0,  75,70,0,  70,70,0,  70,75,0,
                         75,70,0,  70,70,0,  75,75,0,  75,70,0,
                         70,70,0,  70,70,0,  75,70,0,  70,70,0};

  uint8_t rnPack[96] = {255,0,0,  255,0,0,  255,0,0,  0,0,0,
                        0,255,0,  0,255,0,  0,255,0,  0,0,0,
                        0,0,255,  0,0,255,  0,0,255,  0,0,0,
                        255,255,0,  255,255,0,  255,255,0,  0,0,0,
                        0,255,255,  0,255,255,  0,255,255,  0,0,0,
                        255,0,255,  255,0,255,  255,0,255,  0,0,0,
                        255,255,215,  255,255,215,  255,255,215,  0,0,0,
                        255,215,0,  255,215,0,  255,215,0,  0,0,0};

  uint8_t igPack[96] = {255,255,215,  255,255,215, 255,255,215, 255,255,215,  
                        255,  0,  0,  255,  0,  0, 255,  0,  0, 255,  0,  0,  
                          0,255,  0,    0,255,  0,   0,255,  0,   0,255,  0,  
                          0,  0,255,    0,  0,255,   0,  0,255,   0,  0,255,
                        255,255,215,  255,255,215, 255,255,215, 255,255,215,  
                        255,  0,  0,  255,  0,  0, 255,  0,  0, 255,  0,  0,  
                          0,255,  0,    0,255,  0,   0,255,  0,   0,255,  0,  
                          0,  0,255,    0,  0,255,   0,  0,255,   0,  0,255,
                       };

 uint8_t itPack[96] = {255,255,215,  255,255,215,  0,0,0,  0,0,0,
                       0,0,0,  0,0,0,  0,0,0,  0,0,0,
                       0,0,0,  0,0,0,  0,0,0,  0,0,0,
                       255,215,0,  255,215,0,  0,0,0,  0,0,0,
                       0,0,0,  0,0,0,  0,0,0,  0,0,0,
                       255,215,0,  255,215,0,  0,0,0,  0,0,0,
                       0,0,0,  0,0,0,  0,0,0,  0,0,0,
                       255,215,0,  255,215,0,  0,0,0,  0,0,0};

 uint8_t X1Pack[96] =     {255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,0,0,     0,255,0,     255,215,0,   255,0,0, 
                           0,255,0,     255,0,0,     0,255,0,     255,0,0, 
                           255,215,0,   0,255,0,     255,0,0,     0,255,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,215,0,   255,215,0,   255,0,0,     0,255,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,215,0,   255,215,0,   255,0,0,     0,255,0};

 uint8_t X2Pack[96] =  {255,215,0,   255,0,0,     0,255,0,     255,0,0,  // 0123
                        0,255,0,     255,0,0,     0,255,0,     255,0,0,  // 4567
                        0,255,0,     255,215,0,   255,0,0,     0,255,0,  // 89AB
                        255,0,0,    0,255,0,    255,0,0,     255,215,0,  // CDEF
                        0,255,0,     255,0,0,     0,255,0,     255,0,0,  // 0123
                        0,255,0,     255,0,0,     0,255,0,     255,215,0,// 4567
                        255,215,0,   255,0,0,     0,255,0,     255,0,0,  // 89AB
                        0,255,0,     255,0,0,     0,255,0,     255,215,0};//DCEF

 uint8_t X3Pack[96] =     {255,0,0,     0,255,0,     255,215,0,   255,215,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,215,0,   255,0,0,     0,255,0,     255,0,0, 
                           0,255,0,     255,0,0,     255,215,0,   0,255,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,0,0,     0,255,0,     255,215,0,   255,215,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0};

 uint8_t X4Pack[96] =     {0,255,0,     255,0,0,     0,255,0,     255,0,0, 
                           0,255,0,     255,215,0,   255,215,0,   255,0,0, 
                           0,255,0,     255,0,0,     0,255,0,     255,0,0, 
                           0,255,0,     255,0,0,     0,255,0,     255,215,0, 
                           255,0,0,     0,255,0,     255,0,0,     0,255,0, 
                           255,0,0,     255,215,0,   0,255,0,     255,0,0, 
                           0,255,0,     255,0,0,     0,255,0,     255,0,0, 
                           0,255,0,     255,215,0,   255,215,0,   255,0,0};

  size_t n = sizeof(whitePack);
  size_t l = sizeof(dest);
  size_t m = getEncodedBufferSize(l);

//  printf("Hello, welcome to Ben's Halftime Toolkit!\n");

  // XBEE init 
  if ((ftdi = ftdi_new()) == 0)
    {
      fprintf(stderr, "ftdi_new failed\n");
      return EXIT_FAILURE;
    } else {
    fprintf(stderr, "ftdi_new success\n");
  }
  if ((res = ftdi_usb_find_all(ftdi, &devlist, 0x0403, 0x6001)) <0) {
    fprintf(stderr, "no ftdi devices found\n");
//    ftdi_list_free(&devlist);
//    ftdi_free(ftdi);
    return 1;
  } else {
    fprintf(stderr, "%d ftdi devices found.\n", res);
  }
    i = 0;
    for (curdev = devlist; curdev != NULL; i++)
    {
        printf("Checking device: %d\n", i);
        if ((ret = ftdi_usb_get_strings(ftdi, curdev->dev, manufacturer, 128, description, 128, NULL, 0)) < 0)
        {
            fprintf(stderr, "ftdi_usb_get_strings failed: %d (%s)\n", ret, ftdi_get_error_string(ftdi));
            retval = EXIT_FAILURE;
            ftdi_list_free(&devlist);
            ftdi_free(ftdi);
        }
        printf("Manufacturer: %s, Description: %s\n\n", manufacturer, description);
        curdev = curdev->next;
    }


  // open ftdi context
  if ((ret = ftdi_usb_open_dev(ftdi, devlist->dev)) < 0)
    {
      fprintf(stderr, "unable to open ftdi: %d (%s)\n", ret, ftdi_get_error_string(ftdi));
      ftdi_free(ftdi);
      return ret;            
    }
  else {
    fprintf(stderr, "ftdi_open successful\n");
  }

  ret = ftdi_set_baudrate(ftdi, 57600);
  if (ret < 0) {
    fprintf(stderr, "unable to set baud rate: %d (%s).\n", ret, ftdi_get_error_string(ftdi));
  } else {
    printf("baudrate set.\n");
  }

  f = ftdi_set_line_property(ftdi, 8, STOP_BIT_1, NONE);
  if(f < 0) {
    fprintf(stderr, "unable to set line parameters: %d (%s).\n", ret, ftdi_get_error_string(ftdi));
  } else {
    printf("line parameters set.\n");
  }

  ftdi_list_free(&devlist);
  printf("broadcasting.\n");

  //open curses session
  initscr();
  raw();
  keypad(stdscr, TRUE);
  nodelay(stdscr, TRUE);
  noecho();
  attron(A_BOLD);
  printw("Hello, welcome to Ben's Halftime Toolkit!\n");
  printw("a=twinkle routine; r=red flash; e=green flash; b=blue flash\n");
  printw("d=dark; g=gold flash;  w=white flash; t=test\n");
  printw("n=gold on; o=white on\n");
  printw("m=magenta; y=yellow flash;  k=cyan flash\n");

  printw("c=christmas sparkle;  k=cyan flash\n");
  printw("f=twink8; h=twink9; j=twink10; l= twink11\n");
  printw("s=rainbow short;  p=rainbow med\n");
  printw("q=sparkle; x=XMas solid; z=slow twinkle\n");
  printw("[=marqee one way; ]=marqee the other;\n");
  printw("1=snowman1; 2=snowman2; 3=tree1; 4=tree2;\n");
  printw("i=chase; `= piano\n");
  printw("\n");
  printw("comma key <,> to stop the loops\n");
  printw("dot key <.> to quit\n");

  do {
    letter = getch();
    switch(letter) {

    case 'b':  // blue flash
      nbytes = ftdi_write_data(ftdi, bluePack, m);
      usleep(DAB);
      break;

    case 'c':  // christmas sparkle
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, X1Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, X2Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, X3Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, X4Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');  
      break;

    case 'd':  // dark
      nbytes = ftdi_write_data(ftdi, dPack, m);
      usleep(DAB);
      break;

    case 'e':  // green flash
      nbytes = ftdi_write_data(ftdi, greenPack, m);
      usleep(DAB);
      break;

    case 'f':   // twnk8 flash
      nbytes = ftdi_write_data(ftdi, twnk8Pack, m);
      usleep(DAB);
      break;

    case 'g':  // gold flash
      nbytes = ftdi_write_data(ftdi, goldPack, m);
      usleep(DAB);
      break;

    case 'h':   // twnk9 flash
      nbytes = ftdi_write_data(ftdi, twnk9Pack, m);
      usleep(DAB);
      break;

    case 'j':   // tnk10 flash
      nbytes = ftdi_write_data(ftdi, twnk10Pack, m);
      usleep(DAB);
      break;

    case 'k':  // cyan flash
      nbytes = ftdi_write_data(ftdi, cyanPack, m);
      usleep(DAB);
      break;

    case 'l':   // tnk11 flash
      nbytes = ftdi_write_data(ftdi, twnk11Pack, m);
      usleep(DAB);
      break;

    case 'm':  // magenta flash
      nbytes = ftdi_write_data(ftdi, magentaPack, m);
      usleep(DAB);
      break;

    case 'n':  // gold on
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, goldPack, m);
	usleep(DORK);
      } while (myterm != ',');  
      break;

    case 'o':  // white on
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, whitePack, m);
	usleep(DOT);
      } while (myterm != ',');  
      break;

    case 'p':  // rainbow med
      nbytes = ftdi_write_data(ftdi, rain5Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain6Pack, m);
      usleep(DAB);
      nbytes = ftdi_write_data(ftdi, rain6Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain7Pack, m);
      usleep(DAB);
      nbytes = ftdi_write_data(ftdi, rain7Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain8Pack, m);
      usleep(DAB);
      nbytes = ftdi_write_data(ftdi, rain8Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, dPack, m);
      usleep(DAB);
      nbytes = ftdi_write_data(ftdi, dPack, m);
      break;

      // 'q' coded below

    case 'r':  // red flash
      nbytes = ftdi_write_data(ftdi, redPack, m);
      usleep(DAB);
      break;

    case 's':  // rainbow short
      nbytes = ftdi_write_data(ftdi, rain1Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain2Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain3Pack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, rain4Pack, m);
      usleep(DASH);
      break;

    case 't':  // rainbow short
      nbytes = ftdi_write_data(ftdi, redPack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, greenPack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, bluePack, m);
      usleep(DASH);
      nbytes = ftdi_write_data(ftdi, whit2Pack, m);
      usleep(DASH);
      break;

    case 'w':  // white flash
      nbytes = ftdi_write_data(ftdi, whitePack, m);
      usleep(DAB);
      break;

    case 'x':  // christmas solid
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, X1Pack, m);
	usleep(DROOL);
      } while (myterm != ',');   
      break;

    case 'y':  // yellow flash
      nbytes = ftdi_write_data(ftdi, yellowPack, m);
      usleep(DAB);
      break;

    case 'z':  // slow christmas twinkle
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, X1Pack, m);
	usleep(DASH);
	usleep(DASH);
	nbytes = ftdi_write_data(ftdi, X2Pack, m);
	usleep(DASH);
	usleep(DASH);
	nbytes = ftdi_write_data(ftdi, X3Pack, m);
	usleep(DASH);
	usleep(DASH);
	nbytes = ftdi_write_data(ftdi, X4Pack, m);
	usleep(DASH);
	usleep(DASH);
      } while (myterm != ',');      
      break;

    case 'a':  //asterion
      do {
	myterm = getch();

	nbytes = ftdi_write_data(ftdi, twnk1Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk2Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk3Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk4Pack, m);
	usleep(DROOL);

	nbytes = ftdi_write_data(ftdi, twnk5Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk6Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk7Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk8Pack, m);
	usleep(DROOL);

	nbytes = ftdi_write_data(ftdi, twnk9Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk10Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk11Pack, m);
	usleep(DROOL);
	nbytes = ftdi_write_data(ftdi, twnk12Pack, m);
	usleep(DROOL);
      } while (myterm != ','); 
      break;

    case 'q':   // rainbow cycle
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, rain1Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, rain2Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, rain3Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, rain4Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;

    case '`':   // rainbow cycle
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, spark1Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, spark2Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, spark3Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, spark4Pack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;

    case '1':   // snowman w/ white
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, snowman1,  m);
	usleep(SLP);
        rotate13(snowman1);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, snowman1,  m);
	usleep(SLP);
        rotate13(snowman1);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;

    case '2':   // snowman w/ white1
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, snowman2,  m);
	usleep(SLP);
        rotate13(snowman2);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, snowman2,  m);
	usleep(SLP);
        rotate13(snowman2);
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;

    case '3':   // tree1 (gold sparkle, colorguard red)
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, tree1,     m);
	usleep(SLP);
        rotate13(tree1   );
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, tree1,     m);
	usleep(SLP);
        rotate13(tree1   );
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;

    case '4':   // tree1 (white sparkle, colorguard red/gold)
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, tree2,     m);
	usleep(SLP);
        rotate13(tree2   );
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
	nbytes = ftdi_write_data(ftdi, tree2,     m);
	usleep(SLP);
        rotate13(tree2   );
	nbytes = ftdi_write_data(ftdi, dPack, m);
	usleep(SLP);
      } while (myterm != ',');      
      break;




    case '<':   // dimmer code
      printw("getting dimmer...TBA");
      break;

    case '>':   // brighter code
      printw("getting brighter...TBA");
      break;

    case '[':   // marqee left
      // load the broadcast array
      for (i=0; i<96; i++) {
	sorc[i] = igPack[i];
      }
      // loop
      do {
	myterm = getch();
	// store the rollover values
	for (i=0; i<3; i++) {
	  temp[i] = sorc[i];
	}
	for (i=0; i<96; i++) {
	  if(i<93)
	    sorc[i] = sorc[i+3];
	  else sorc[i] = temp[i%3];
	}
	nbytes = ftdi_write_data(ftdi, sorc, m);
        usleep(DAB);
      } while (myterm != ',');  
      break;

    case ']':   // marqee right
      for (i=0; i<96; i++) {
	sorc[i] = igPack[i];
      }

      do {
	myterm = getch();
	for (i=93; i<96; i++) {
	  temp[i-93] = sorc[i];
	}
	for (i=95; i>-1; i--) {
	  if(i>2)
	    sorc[i] = sorc[i-3];
	  else sorc[i] = temp[i];
	}
	nbytes = ftdi_write_data(ftdi, sorc, m);
        usleep(DAB);
      } while (myterm != ',');  
      break;

    case 'i':
      do {
	myterm = getch();
	nbytes = ftdi_write_data(ftdi, chasePack, m);
	usleep(DAB);
        chase(chasePack);
        chaseUpper(chasePack);
      } while (myterm != ',');  
      break;

    default:
      usleep(DAB);
    }
    nbytes = ftdi_write_data(ftdi, dPack, m);
  } while (letter != '.');
  
  endwin();   // close curses session
  
  if ((ret = ftdi_usb_close(ftdi)) < 0)
    {
      fprintf(stderr, "unable to close ftdi1: %d (%s)\n", ret, ftdi_get_error_string(ftdi));
      return 1;
    }

  ftdi_free(ftdi);
  
  printf("End of program.\n");
  
  return 0;
} // END main

void rotate13 (uint8_t arr[])
  {
    // This routine rotates the values in the lower 13 channels (channels 0-12)
    // since the flags are on channels 13 and 14, they are left alone
   uint8_t  r, g, b;
   int i, j, nrot;

   r = arr[0];
   g = arr[1];
   b = arr[2];

   nrot = 13;
   for(i = 3; i < nrot; i+=3)
     {
      arr[i-3] = arr[i];
      arr[i-2] = arr[i+1];
      arr[i-1] = arr[i+2];
     } // for i
 
   arr[nrot*3] = r;
   arr[nrot*3+1] = g;
   arr[nrot*3+2] = b;

  } // END rotate12



static size_t getEncodedBufferSize(size_t sourceSize)
{
  size_t s;
  s = sourceSize + sourceSize / 254 + 1;
  //printf("buffer size is : %zd.\n", s);
  return s;
}

void chase(uint8_t pack[])
{
    uint8_t newPack[96];
    int i, numChannels = 14;
    int tempr = pack[0];
    int tempg = pack[1];
    int tempb = pack[2];
    for(i=0; i<numChannels*3; i+=3)
    {
        pack[i] = pack[i+3];
        pack[i+1] = pack[i+4];
        pack[i+2] = pack[i+5];
    }
    pack[numChannels*3] = tempr;
    pack[numChannels*3+1] = tempg;
    pack[numChannels*3+2] = tempb;
//    printPack(pack);
}

void printPack(uint8_t pack[])
{
    printf("printing\n");
    int i=0, numChannels = 14;
    for(i=0; i<numChannels*3; i+=3) {
        printf("%d r: %d\n", i, pack[i]);
        printf("%d g: %d\n", i+1, pack[i+1]);
        printf("%d b: %d\n", i+2, pack[i+2]);
    }
}

void chaseUpper(uint8_t pack[])
{
    uint8_t newPack[96];
    int i, numChannels = 14;
    int tempr = pack[48];
    int tempg = pack[49];
    int tempb = pack[50];
    for(i=48; i<numChannels*3+48; i+=3)
    {
        pack[i] = pack[i+3];
        pack[i+1] = pack[i+4];
        pack[i+2] = pack[i+5];
    }
    pack[numChannels*3+48] = tempr;
    pack[numChannels*3+1+48] = tempg;
    pack[numChannels*3+2+48] = tempb;
//    printPack(pack);
}
